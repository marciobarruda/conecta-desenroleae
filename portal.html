<!doctype html>
<html lang="pt-BR">
  <!-- Portal do Festival de Teatro do Recife • Catálogo -->
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Symplifica Conecta</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-secondary: #003a73;
        --brand-highlight: #00a3ff;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
        --shadow-strong: 0 14px 30px rgba(0,35,79,.15);
      }
      *,*::before,*::after{box-sizing:border-box}
      body{
        font-family:"Public Sans",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
        background:var(--surface);color:var(--text-strong);min-height:100vh
      }
      header.site-header{
        background:url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000") center/cover no-repeat;
        color:#fff;padding:3rem 0 2.25rem
      }
      header .lead{color:rgba(255,255,255,.9);font-size:1rem;line-height:1.65}
      .badge-open{display:inline-flex;align-items:center;gap:.5rem;font-size:.95rem;font-weight:600;padding:.45rem .9rem;border-radius:999px;background:rgba(255,255,255,.14)}
      .section-title{display:flex;align-items:center;gap:.65rem;font-weight:700;font-size:1.2rem;color:var(--text-strong)}
      .section-title::before{content:"";display:inline-block;width:32px;height:3px;border-radius:999px;background:var(--brand-highlight)}
      .card-programa{border:1px solid rgba(0,83,164,.08);background:var(--surface-strong);box-shadow:0 16px 34px rgba(0,45,98,.08)}
      .catalog-toolbar .form-select,.catalog-toolbar .form-control{border-color:var(--border-color)}
      /* ===== Ticket card (estilo do exemplo) ===== */
      .ticket-card{
        background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:var(--shadow-strong);overflow:hidden;position:relative
      }
      .ticket-cover{background:#e9eef7}
      .poster-img{width:100%;height:100%;object-fit:cover;display:block}
      .ticket-body{padding:1rem 1rem 1.1rem;position:relative}
      /* Semicírculos nas laterais (efeito ‘talão’) */
      .ticket-body::before,.ticket-body::after{
        content:"";position:absolute;top:-12px;width:24px;height:24px;background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:50%;
        box-shadow:0 0 0 6px #fff inset
      }
      .ticket-body::before{left:-12px}
      .ticket-body::after{right:-12px}
      .ci{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 .4rem;border-radius:6px;font-weight:800;font-size:.85rem;color:#fff}
      .ci.l{background:#2aa84a}
      .ci.c10{background:#1f87c9}
      .ci.c12{background:#f4b400}
      .ci.c14{background:#ef6c00}
      .ci.c16{background:#d84315}
      .ci.c18{background:#212121}
      .meta-label{font-size:.78rem;color:var(--text-muted)}
      .link-action{font-weight:700;text-decoration:none}
      .link-action:hover{text-decoration:underline}
      .btn-fav[aria-pressed="true"]{border-color:#ffc107!important}
      .catalog-grid .col{display:flex}
      .catalog-grid .ticket-card{display:flex;flex-direction:column;width:100%}
      .ticket-card.is-muted{filter:grayscale(1);opacity:.55;transition:filter .2s ease,opacity .2s ease}
      .ticket-card.is-active{box-shadow:0 0 0 .15rem rgba(0,83,164,.35)}
      #modalDetalhes .modal-dialog{max-width:980px}
      #modalDetalhes .modal-content{border-radius:18px;overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.18)}
      #modalDetalhes .modal-header,#modalDetalhes .modal-footer{background:var(--surface);border-color:rgba(0,0,0,.05)}
      #modalDetalhes .modal-body{padding:2rem}
      .modal-poster{background:#e9eef7;border-radius:14px;overflow:hidden;box-shadow:0 10px 26px rgba(0,45,98,.14);min-height:360px}
      .modal-poster img{width:100%;height:100%;object-fit:cover;display:block}
      @media (max-width:768px){
        header.site-header{padding:2.25rem 0 1.75rem}
        .badge-open{width:100%;justify-content:center}
        #modalDetalhes .modal-body{padding:1.5rem}
      }
      @media (max-width:576px){
        .catalog-toolbar .row > * + *{margin-top:.5rem}
        #modalDetalhes .modal-body{padding:1.25rem}
      }
      /* ===== Ajustes adicionais para o catálogo dinâmico ===== */
      main{
        max-width:1100px;margin:-3rem auto 4rem;padding:0 1.5rem 3rem
      }
      section.catalogo{
        background:var(--surface-strong);border-radius:18px;padding:2.5rem clamp(1.25rem,4vw,3rem);box-shadow:0 24px 60px rgba(0,40,90,.14)
      }
      .catalogo header{
        margin-bottom:2rem;display:flex;flex-direction:column;gap:.5rem
      }
      .catalogo header h2{
        font-size:1.75rem;font-weight:700;margin:0;color:var(--brand-secondary)
      }
      .catalogo header p{
        margin:0;color:var(--text-muted)
      }
      .catalog-grid{
        display:grid;gap:1.75rem;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))
      }
      .ticket-card{
        cursor:pointer;transition:transform .2s ease,box-shadow .2s ease,filter .2s ease,opacity .2s ease
      }
      .ticket-card:hover{transform:translateY(-4px);box-shadow:0 24px 55px rgba(0,35,79,.18)}
      .ticket-card.inativo{
        filter:grayscale(100%);opacity:.55;pointer-events:none;transform:none;box-shadow:var(--shadow-strong)
      }
      .ticket-card.selecionado{
        box-shadow:0 0 0 .15rem rgba(0,83,164,.35)
      }
      .ticket-cover{
        aspect-ratio:16/10;background:#e7edf8;overflow:hidden
      }
      .ticket-cover img{
        width:100%;height:100%;object-fit:cover;display:block
      }
      .ticket-body{
        display:flex;flex-direction:column;gap:.85rem;padding:1.4rem 1.35rem 1.5rem
      }
      .ticket-title{
        font-size:1.2rem;margin:0;font-weight:700;color:var(--text-strong)
      }
      .ticket-meta,.ticket-data,.ticket-disponiveis{
        margin:0;font-size:.95rem;color:var(--text-muted)
      }
      .ticket-disponiveis{
        font-weight:600;color:var(--brand-secondary)
      }
      .badge-classificacao{
        display:inline-flex;align-items:center;padding:.25rem .55rem;border-radius:999px;background:rgba(0,163,255,.12);color:var(--brand-secondary);font-size:.78rem;font-weight:700;text-transform:uppercase;letter-spacing:.04em
      }
      .ticket-actions{
        display:flex;flex-wrap:wrap;gap:.75rem;margin-top:auto
      }
      .btn-ingresso,.btn-detalhes{
        border:none;border-radius:10px;padding:.75rem 1rem;font-weight:600;font-size:.95rem;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease,background .2s ease
      }
      .btn-ingresso{
        flex:1;background:var(--brand-primary);color:#fff;box-shadow:0 12px 25px rgba(0,83,164,.24)
      }
      .btn-ingresso:hover{transform:translateY(-1px);box-shadow:0 18px 28px rgba(0,83,164,.26)}
      .btn-ingresso.selecionado{
        background:#1f8f4d;box-shadow:0 14px 30px rgba(31,143,77,.24)
      }
      .btn-detalhes{
        background:rgba(0,83,164,.12);color:var(--brand-secondary)
      }
      .btn-detalhes:hover{background:rgba(0,83,164,.18)}
      .status-mensagem{
        margin:2rem 0 0;text-align:center;color:var(--text-muted)
      }
      .status-mensagem[hidden]{display:none!important}
      .modal-dinamico{
        position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .25s ease
      }
      .modal-dinamico.is-open{opacity:1;pointer-events:auto}
      .modal-dinamico__backdrop{position:absolute;inset:0;background:rgba(17,28,45,.55)}
      .modal-dinamico__dialog{
        position:relative;background:#fff;border-radius:20px;overflow:hidden;width:min(92vw,960px);max-height:calc(100vh - 3rem);display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:0;box-shadow:0 28px 70px rgba(0,20,50,.38);transform:translateY(18px);transition:transform .25s ease
      }
      .modal-dinamico.is-open .modal-dinamico__dialog{transform:translateY(0)}
      .modal-dinamico__close{
        position:absolute;top:1.1rem;right:1.1rem;width:42px;height:42px;border-radius:50%;border:none;background:rgba(255,255,255,.88);color:var(--brand-secondary);font-size:1.3rem;font-weight:600;cursor:pointer;box-shadow:0 12px 28px rgba(0,0,0,.12)
      }
      .modal-dinamico__media{background:#e9eef7;min-height:360px}
      .modal-dinamico__media img{width:100%;height:100%;object-fit:cover;display:block}
      .modal-dinamico__content{
        padding:clamp(1.5rem,2vw + 1rem,2.5rem);display:flex;flex-direction:column;gap:1rem;overflow-y:auto
      }
      .modal-dinamico__content h2{
        margin:0;font-size:clamp(1.6rem,2vw + 1rem,2.25rem);color:var(--brand-secondary)
      }
      .modal-dinamico__sinopse{
        margin:0;color:var(--text-strong);line-height:1.65
      }
      .modal-dinamico__info{
        list-style:none;padding:0;margin:0;display:grid;gap:.5rem;font-size:.98rem;color:var(--text-muted)
      }
      .modal-dinamico__info strong{color:var(--brand-secondary)}
      @media (max-width:880px){
        .modal-dinamico__dialog{grid-template-columns:minmax(0,1fr)}
        .modal-dinamico__media{max-height:320px}
      }
      @media (max-width:640px){
        header.site-header{padding:2.25rem 0 1.75rem}
        main{margin-top:-2.25rem}
        section.catalogo{padding:2rem 1.25rem}
        .ticket-actions{flex-direction:column}
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <div class="header-wrapper">
        <div>
          <h1>Desenrole aê</h1>
          <p>Confira os espetáculos disponíveis e garanta seu ingresso gratuito.</p>
        </div>
      </div>
    </header>

    <main>
      <section class="catalogo" aria-labelledby="tituloCatalogo">
        <header>
          <h2 id="tituloCatalogo">Catálogo de espetáculos</h2>
          <p>Os cards são carregados automaticamente a partir do webhook oficial.</p>
        </header>

        <div class="catalog-grid" data-lista-eventos></div>
        <p class="status-mensagem" data-status hidden></p>
      </section>
    </main>

    <script>
      const API_URL = "https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/2917bb59-51f3-478a-a435-0753ab258f43";
      const listaEventosEl = document.querySelector("[data-lista-eventos]");
      const statusMensagemEl = document.querySelector("[data-status]");

      const estado = {
        eventos: [],
        mapaEventos: new Map(),
        selecionadosPorData: {},
        modalAberto: null,
      };

      window.addEventListener("load", fetchEventos);
      listaEventosEl.addEventListener("click", delegarInteracaoNosCards);

      async function fetchEventos() {
        atualizarStatus("Carregando eventos...");
        try {
          const resposta = await fetch(API_URL);
          if (!resposta.ok) {
            throw new Error(`Falha ao buscar eventos: ${resposta.status}`);
          }

          const dados = await resposta.json();
          if (!Array.isArray(dados)) {
            throw new Error("O formato de dados retornado é inválido.");
          }

          estado.eventos = dados;
          estado.mapaEventos = new Map(dados.map((item) => [item.id, item]));
          renderCards(dados);
          atualizarStatus(dados.length ? "" : "Nenhum evento disponível no momento.");
        } catch (erro) {
          console.error(erro);
          atualizarStatus("Não foi possível carregar os eventos. Tente novamente mais tarde.");
        }
      }

      function atualizarStatus(mensagem) {
        if (!mensagem) {
          statusMensagemEl.textContent = "";
          statusMensagemEl.hidden = true;
          return;
        }
        statusMensagemEl.textContent = mensagem;
        statusMensagemEl.hidden = false;
      }

      function renderCards(eventos) {
        listaEventosEl.innerHTML = "";
        eventos.forEach((evento) => {
          const card = document.createElement("article");
          const dataNormalizada = normalizaData(evento.quando);
          card.className = "ticket-card";
          card.dataset.id = evento.id || "";
          card.dataset.dateKey = dataNormalizada;
          card.innerHTML = criarMarkupDoCard(evento);
          listaEventosEl.appendChild(card);
        });

        Object.keys(estado.selecionadosPorData).forEach((chave) => {
          toggleCardsPorData(chave);
        });
      }

      function criarMarkupDoCard(evento) {
        const dataHoraFormatada = formatarDataHora(evento.quando, evento.hora);
        const quantidadeDisponiveis = typeof evento.disponiveis === "number" ? evento.disponiveis : "-";
        const quantidadeTotal = typeof evento.disponibilizados === "number" ? evento.disponibilizados : "-";
        const poster = evento.poster || "https://statics.recife.pe.gov.br/images/dynamics/conecta/placeholders/poster.png";
        return `
          <figure class="ticket-cover">
            <img src="${escapeHtml(poster)}" alt="Pôster do espetáculo ${escapeHtml(evento.nome || "")}" loading="lazy" />
          </figure>
          <div class="ticket-body">
            <span class="badge-classificacao">${escapeHtml(evento.classificacao || "Classificação livre")}</span>
            <h3 class="ticket-title">${escapeHtml(evento.nome || "Espetáculo")}</h3>
            <p class="ticket-meta">${escapeHtml(evento.genero || "Gênero não informado")} • ${escapeHtml(evento.local || "Local a definir")}</p>
            <p class="ticket-data">${dataHoraFormatada || "Data a definir"}</p>
            <p class="ticket-disponiveis">Disponíveis: ${quantidadeDisponiveis} / ${quantidadeTotal}</p>
            <div class="ticket-actions">
              <button
                type="button"
                class="btn-ingresso"
                data-role="pegar-ingresso"
                data-id="${escapeHtml(evento.id || "" )}"
                data-quando="${escapeHtml(evento.quando || "" )}"
                aria-pressed="false"
              >Pegar ingresso 🎟️</button>
              <button type="button" class="btn-detalhes" data-role="detalhes">Detalhes</button>
            </div>
          </div>
        `;
      }

      function delegarInteracaoNosCards(evento) {
        const botaoIngresso = evento.target.closest("[data-role=pegar-ingresso]");
        if (botaoIngresso) {
          evento.stopPropagation();
          const id = botaoIngresso.dataset.id;
          const dataQuando = botaoIngresso.dataset.quando;
          if (id && dataQuando) {
            alternarSelecaoDeIngresso(id, dataQuando);
          }
          return;
        }

        const botaoDetalhes = evento.target.closest("[data-role=detalhes]");
        if (botaoDetalhes) {
          evento.stopPropagation();
          const card = botaoDetalhes.closest(".ticket-card");
          if (card) {
            const dados = estado.mapaEventos.get(card.dataset.id);
            if (dados) {
              abrirModal(dados);
            }
          }
          return;
        }

        const card = evento.target.closest(".ticket-card");
        if (card && !card.classList.contains("inativo")) {
          const dados = estado.mapaEventos.get(card.dataset.id);
          if (dados) {
            abrirModal(dados);
          }
        }
      }

      function alternarSelecaoDeIngresso(id, dataQuando) {
        const chaveData = normalizaData(dataQuando);
        if (!chaveData) return;

        const selecionadoAtual = estado.selecionadosPorData[chaveData];
        if (selecionadoAtual === id) {
          delete estado.selecionadosPorData[chaveData];
        } else {
          estado.selecionadosPorData[chaveData] = id;
        }
        toggleCardsPorData(chaveData);
      }

      function toggleCardsPorData(chaveData) {
        const cards = listaEventosEl.querySelectorAll(`.ticket-card[data-date-key="${chaveData}"]`);
        const selecionado = estado.selecionadosPorData[chaveData];

        cards.forEach((card) => {
          const botao = card.querySelector("[data-role=pegar-ingresso]");
          if (!botao) return;

          if (!selecionado) {
            card.classList.remove("inativo", "selecionado");
            botao.classList.remove("selecionado");
            botao.textContent = "Pegar ingresso 🎟️";
            botao.setAttribute("aria-pressed", "false");
            return;
          }

          if (card.dataset.id === selecionado) {
            card.classList.add("selecionado");
            card.classList.remove("inativo");
            botao.classList.add("selecionado");
            botao.textContent = "Cancelar ingresso 🎟️";
            botao.setAttribute("aria-pressed", "true");
          } else {
            card.classList.add("inativo");
            card.classList.remove("selecionado");
            botao.classList.remove("selecionado");
            botao.textContent = "Pegar ingresso 🎟️";
            botao.setAttribute("aria-pressed", "false");
          }
        });
      }

      function abrirModal(dadosDoEvento) {
        fecharModal();

        const modal = document.createElement("div");
        modal.className = "modal-dinamico";
        const dataHora = formatarDataHora(dadosDoEvento.quando, dadosDoEvento.hora);
        const imagemDetalhes = dadosDoEvento.posterdetalhes || dadosDoEvento.poster || "";

        modal.innerHTML = `
          <div class="modal-dinamico__backdrop" data-role="fechar-modal" aria-hidden="true"></div>
          <div class="modal-dinamico__dialog" role="dialog" aria-modal="true" aria-label="Detalhes do espetáculo ${escapeHtml(
            dadosDoEvento.nome || ""
          )}">
            <button type="button" class="modal-dinamico__close" data-role="fechar-modal" aria-label="Fechar detalhes">×</button>
            <div class="modal-dinamico__media">
              <img src="${escapeHtml(imagemDetalhes)}" alt="Pôster detalhado do espetáculo ${escapeHtml(
          dadosDoEvento.nome || ""
        )}" />
            </div>
            <div class="modal-dinamico__content">
              <h2>${escapeHtml(dadosDoEvento.nome || "Espetáculo")}</h2>
              <p class="modal-dinamico__sinopse">${escapeHtml(dadosDoEvento.sinopse || "Sinopse não informada.")}</p>
              <ul class="modal-dinamico__info">
                <li><strong>Classificação:</strong> ${escapeHtml(dadosDoEvento.classificacao || "Não informada")}</li>
                <li><strong>Gênero:</strong> ${escapeHtml(dadosDoEvento.genero || "Não informado")}</li>
                <li><strong>Local:</strong> ${escapeHtml(dadosDoEvento.local || "A definir")}</li>
                <li><strong>Quando:</strong> ${dataHora || "Em breve"}</li>
                <li><strong>Ingressos:</strong> ${typeof dadosDoEvento.disponiveis === "number" ? dadosDoEvento.disponiveis : "-"} disponíveis de ${
          typeof dadosDoEvento.disponibilizados === "number" ? dadosDoEvento.disponibilizados : "-"
        }</li>
              </ul>
            </div>
          </div>
        `;

        modal.addEventListener("click", (evento) => {
          if (evento.target.matches("[data-role=fechar-modal]")) {
            fecharModal();
          }
        });

        document.body.appendChild(modal);
        requestAnimationFrame(() => {
          modal.classList.add("is-open");
        });

        estado.modalAberto = modal;
        document.addEventListener("keydown", escListener);
      }

      function fecharModal() {
        if (!estado.modalAberto) return;
        const modal = estado.modalAberto;
        modal.classList.remove("is-open");
        modal.addEventListener(
          "transitionend",
          () => {
            modal.remove();
          },
          { once: true }
        );
        estado.modalAberto = null;
        document.removeEventListener("keydown", escListener);
      }

      function escListener(evento) {
        if (evento.key === "Escape") {
          fecharModal();
        }
      }

      function normalizaData(valorIso) {
        if (!valorIso) return "";
        const data = new Date(valorIso);
        if (Number.isNaN(data.getTime())) return "";
        try {
          return data.toISOString().slice(0, 10);
        } catch (erro) {
          console.warn("Não foi possível normalizar a data", erro);
          return "";
        }
      }

      function formatarDataHora(quando, hora) {
        const dataFormatada = formatarData(quando);
        const horaFormatada = formatarHora(hora);
        return [dataFormatada, horaFormatada].filter(Boolean).join(", ");
      }

      function formatarData(quando) {
        if (!quando) return "";
        const data = new Date(quando);
        if (Number.isNaN(data.getTime())) return "";

        const formatter = new Intl.DateTimeFormat("pt-BR", {
          day: "2-digit",
          month: "long",
          timeZone: "UTC",
        });

        const partes = formatter.formatToParts(data);
        const dia = partes.find((parte) => parte.type === "day");
        const mes = partes.find((parte) => parte.type === "month");
        const numeroDia = dia ? String(parseInt(dia.value, 10)) : "";
        const nomeMes = mes ? mes.value.toLowerCase() : "";
        return numeroDia && nomeMes ? `${numeroDia} ${nomeMes}` : "";
      }

      function formatarHora(hora) {
        if (!hora) return "";
        const partes = hora.split(":");
        const horas = partes[0];
        const minutos = partes[1];
        if (!horas) return "";
        const horaBase = horas.padStart(2, "0");
        if (minutos && minutos !== "00") {
          return `${horaBase}:${minutos}h`;
        }
        return `${horaBase}h`;
      }

      function escapeHtml(valor) {
        if (valor == null) return "";
        return String(valor)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }
    </script>
  </body>
</html>

<!doctype html>
<html lang="pt-BR">
  <!-- Portal do Festival de Teatro do Recife ‚Ä¢ Cat√°logo -->
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Symplifica Conecta</title>
    <link
      rel="icon"
      href="https://statics.recife.pe.gov.br/images/dynamics/conecta/icons/favicon.png?w=32&h=32&fit=fill&border=2,transparent,shrink"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --brand-primary: #0053a4;
        --brand-secondary: #003a73;
        --brand-highlight: #00a3ff;
        --surface: #f4f7fb;
        --surface-strong: #ffffff;
        --border-color: #d0d7e2;
        --text-strong: #1b263b;
        --text-muted: #5b6c8c;
        --shadow-strong: 0 14px 30px rgba(0,35,79,.15);
      }
      *,*::before,*::after{box-sizing:border-box}
      body{
        font-family:"Public Sans",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
        background:var(--surface);color:var(--text-strong);min-height:100vh
      }
      header.site-header{
        background:url("https://statics.recife.pe.gov.br/images/dynamics/automacao/header.png?w=3000") center/cover no-repeat;
        color:#fff;padding:3rem 0 2.25rem
      }
      header .lead{color:rgba(255,255,255,.9);font-size:1rem;line-height:1.65}
      .badge-open{display:inline-flex;align-items:center;gap:.5rem;font-size:.95rem;font-weight:600;padding:.45rem .9rem;border-radius:999px;background:rgba(255,255,255,.14)}
      .section-title{display:flex;align-items:center;gap:.65rem;font-weight:700;font-size:1.2rem;color:var(--text-strong)}
      .section-title::before{content:"";display:inline-block;width:32px;height:3px;border-radius:999px;background:var(--brand-highlight)}
      .card-programa{border:1px solid rgba(0,83,164,.08);background:var(--surface-strong);box-shadow:0 16px 34px rgba(0,45,98,.08)}
      .catalog-toolbar .form-select,.catalog-toolbar .form-control{border-color:var(--border-color)}
      /* ===== Ticket card (estilo do exemplo) ===== */
      .ticket-card{
        background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:12px;box-shadow:var(--shadow-strong);overflow:hidden;position:relative
      }
      .ticket-cover{background:#e9eef7}
      .poster-img{width:100%;height:100%;object-fit:cover;display:block}
      .ticket-body{padding:1rem 1rem 1.1rem;position:relative}
      /* Semic√≠rculos nas laterais (efeito ‚Äòtal√£o‚Äô) */
      .ticket-body::before,.ticket-body::after{
        content:"";position:absolute;top:-12px;width:24px;height:24px;background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:50%;
        box-shadow:0 0 0 6px #fff inset
      }
      .ticket-body::before{left:-12px}
      .ticket-body::after{right:-12px}
      .ci{display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 .4rem;border-radius:6px;font-weight:800;font-size:.85rem;color:#fff}
      .ci.l{background:#2aa84a}     /* L */
      .ci.c10{background:#1f87c9}   /* 10 */
      .ci.c12{background:#f4b400}   /* 12 */
      .ci.c14{background:#ef6c00}   /* 14 */
      .ci.c16{background:#d84315}   /* 16 */
      .ci.c18{background:#212121}   /* 18 */
      .meta-label{font-size:.78rem;color:var(--text-muted)}
      .link-action{font-weight:700;text-decoration:none}
      .link-action:hover{text-decoration:underline}
      .btn-fav[aria-pressed="true"]{border-color:#ffc107!important}
      .catalog-grid .col{display:flex}
      .catalog-grid .ticket-card{display:flex;flex-direction:column;width:100%}
      .ticket-card.is-muted{filter:grayscale(1);opacity:.55;transition:filter .2s ease,opacity .2s ease}
      .ticket-card.is-active{box-shadow:0 0 0 .15rem rgba(0,83,164,.35)}
      #modalDetalhes .modal-dialog{max-width:980px}
      #modalDetalhes .modal-content{border-radius:18px;overflow:hidden;box-shadow:0 24px 60px rgba(0,0,0,.18)}
      #modalDetalhes .modal-header,#modalDetalhes .modal-footer{background:var(--surface);border-color:rgba(0,0,0,.05)}
      #modalDetalhes .modal-body{padding:2rem}
      .modal-poster{background:#e9eef7;border-radius:14px;overflow:hidden;box-shadow:0 10px 26px rgba(0,45,98,.14);min-height:360px}
      .modal-poster img{width:100%;height:100%;object-fit:cover;display:block}
      @media (max-width:768px){
        header.site-header{padding:2.25rem 0 1.75rem}
        .badge-open{width:100%;justify-content:center}
        #modalDetalhes .modal-body{padding:1.5rem}
      }
      @media (max-width:576px){
        .catalog-toolbar .row > * + *{margin-top:.5rem}
        #modalDetalhes .modal-body{padding:1.25rem}
      }
    </style>
  </head>
  <body>
    <!-- HEADER -->
    <header class="site-header">
      <div class="container">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
          <div>
            <h1 class="display-5 fw-bold mb-2">Desenrole a√™ ‚Ä¢ Symplifica Conecta</h1>
            <p class="lead mb-0">Programa√ß√£o oficial da Secretaria de Cultura do Recife ‚Ä¢ Explore as pe√ßas e escolha seu teatro.</p>
          </div>
          <div class="text-md-end">
            <span class="badge-open"><span aria-hidden="true">üé≠</span> Programa√ß√£o aberta</span>
            <div class="mt-2">
              <button class="btn btn-light btn-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasFav" aria-controls="offcanvasFav">
                Favoritos <span class="badge text-bg-primary align-middle ms-1" id="favCount">0</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- FILTROS -->
    <section class="py-4">
      <div class="container">
        <div class="card card-programa">
          <div class="card-header"><div class="section-title mb-0">Filtrar programa√ß√£o</div></div>
          <div class="card-body catalog-toolbar">
            <div class="row g-3 align-items-end">
              <div class="col-12 col-md-6 col-lg-5">
                <label class="form-label small fw-semibold text-uppercase text-muted">Busca</label>
                <input type="search" id="q" class="form-control" placeholder="Digite nome da pe√ßa, teatro ou trecho da sinopse‚Ä¶" />
              </div>
              <div class="col-6 col-md-3 col-lg-2">
                <label class="form-label small fw-semibold text-uppercase text-muted">Teatro</label>
                <select id="fTeatro" class="form-select"><option value="">Todos</option></select>
              </div>
              <div class="col-6 col-md-3 col-lg-2">
                <label class="form-label small fw-semibold text-uppercase text-muted">Classifica√ß√£o</label>
                <select id="fClass" class="form-select"><option value="">Todas</option></select>
              </div>
              <div class="col-6 col-md-3 col-lg-2">
                <label class="form-label small fw-semibold text-uppercase text-muted">G√™nero</label>
                <select id="fGenero" class="form-select"><option value="">Todos</option></select>
              </div>
              <div class="col-6 col-md-3 col-lg-1 d-grid">
                <button id="btnLimpar" class="btn btn-outline-secondary">Limpar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CAT√ÅLOGO -->
    <section class="py-3">
      <div class="container">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="section-title mb-0">Cat√°logo de pe√ßas</div>
          <small class="text-muted" id="resultInfo">Exibindo 0 de 0</small>
        </div>
        <div id="grid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3 catalog-grid"></div>
      </div>
    </section>

    <!-- MODAL: DETALHES -->
    <div class="modal fade" id="modalDetalhes" tabindex="-1" aria-labelledby="modalTitulo" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fw-bold" id="modalTitulo">T√≠tulo da pe√ßa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-4 align-items-stretch">
              <div class="col-12 col-lg-5 d-flex">
                <div class="modal-poster w-100 h-100">
                  <img id="modalPoster" src="" alt="P√¥ster da pe√ßa" class="poster-img">
                </div>
              </div>
              <div class="col-12 col-lg-7 d-flex flex-column gap-2">
                <div class="mb-2"><span class="ci" id="modalClass">L</span></div>
                <p class="small text-uppercase text-muted fw-semibold mb-1">Teatro</p>
                <p class="fw-semibold" id="modalTeatro">‚Äî</p>
                <p class="small text-uppercase text-muted fw-semibold mb-1">Data</p>
                <p class="fw-semibold" id="modalQuando">‚Äî</p>
                <p class="small text-uppercase text-muted fw-semibold mb-1">G√™nero</p>
                <p class="fw-semibold" id="modalGenero">‚Äî</p>
                <p class="mb-0 mt-3" id="modalSinopse">‚Äî</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="modalTicketBtn" type="button" class="btn btn-outline-primary" aria-pressed="false">üéüÔ∏è Pegar ingresso</button>
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- OFFCANVAS: FAVORITOS -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasFav" aria-labelledby="offcanvasFavLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasFavLabel">Favoritos</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Fechar"></button>
      </div>
      <div class="offcanvas-body">
        <div id="favList" class="list-group"></div>
        <div class="mt-3 d-flex gap-2">
          <button id="btnExportFav" class="btn btn-outline-primary btn-sm">Exportar IDs</button>
          <button id="btnClearFav" class="btn btn-outline-danger btn-sm">Limpar favoritos</button>
        </div>
      </div>
    </div>

    <!-- RODAP√â -->
    <footer class="py-5">
      <div class="container text-center small text-muted">
        Secretaria de Cultura do Recife ‚Ä¢ Prefeitura do Recife
      </div>
    </footer>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      (function () {
        const API_URL = 'https://webhook-n8n-dev-conectarecife.recife.pe.gov.br/webhook/2917bb59-51f3-478a-a435-0753ab258f43';
        const FALLBACK_EVENTOS = [
          {
            id: 'aurora-nas-esquinas',
            nome: 'Aurora nas Esquinas',
            classificacao: '12+',
            genero: 'Drama',
            local: 'Teatro Santa Isabel',
            quando: '2024-10-12',
            hora: '16:00:00',
            poster: 'https://deliriumnerd.com/wp-content/uploads/2019/08/aurora-nas-sombras-darkside-destacada-1024x538.jpg',
            posterdetalhes: 'https://deliriumnerd.com/wp-content/uploads/2019/08/aurora-nas-sombras-darkside-destacada-1024x538.jpg',
            sinopse: 'Uma viagem po√©tica pelas ruas do Recife, onde mem√≥rias se cruzam com o cotidiano e cada esquina revela afetos e segredos que insistem em permanecer vivos.',
            disponibilizados: 120,
            disponiveis: 68
          },
          {
            id: 'maresia',
            nome: 'Maresia',
            classificacao: 'Livre',
            genero: 'Teatro-dan√ßa',
            local: 'Teatro Apolo',
            quando: '2024-10-12',
            hora: '19:00:00',
            poster: 'https://www.papocult.com.br/wp-content/uploads/2023/08/Cia-Acaso-Maresia-divulgacao.jpg',
            posterdetalhes: 'https://www.papocult.com.br/wp-content/uploads/2023/08/Cia-Acaso-Maresia-divulgacao.jpg',
            sinopse: 'Entre calmarias e tempestades, uma fam√≠lia ribeirinha enfrenta mudan√ßas clim√°ticas e afetivas, assinando pactos silenciosos com o vento e a mar√©.',
            disponibilizados: 90,
            disponiveis: 41
          },
          {
            id: 'o-auto-do-frevo',
            nome: 'O Auto do Frevo',
            classificacao: '10+',
            genero: 'Musical',
            local: 'Pa√ßo do Frevo',
            quando: '2024-10-14',
            hora: '18:00:00',
            poster: 'https://midias.diariodepernambuco.com.br/static/app/noticia_127983242361/2016/12/15/680255/20161215172830466281i.jpg',
            posterdetalhes: 'https://midias.diariodepernambuco.com.br/static/app/noticia_127983242361/2016/12/15/680255/20161215172830466281i.jpg',
            sinopse: 'Musical festivo que mistura frevo, teatro e narrativa popular para contar a saga de um estandarte que ganha vida e sai em busca da sua orquestra.',
            disponibilizados: 150,
            disponiveis: 102
          },
          {
            id: 'paredes-que-falam',
            nome: 'Paredes que Falam',
            classificacao: '14+',
            genero: 'Experimental',
            local: 'Teatro Luiz Mendon√ßa',
            quando: '2024-10-15',
            hora: '20:00:00',
            poster: 'https://f.i.uol.com.br/fotografia/2025/04/02/174362328467ed947488792_1743623284_3x2_md.jpg',
            posterdetalhes: 'https://f.i.uol.com.br/fotografia/2025/04/02/174362328467ed947488792_1743623284_3x2_md.jpg',
            sinopse: 'Em um edif√≠cio hist√≥rico prestes a ruir, moradores compartilham lembran√ßas e disputas, enquanto o passado sussurra pelos azulejos e pelas portas entreabertas.',
            disponibilizados: 110,
            disponiveis: 36
          },
          {
            id: 'cartas-para-clarice',
            nome: 'Cartas para Clarice',
            classificacao: '16+',
            genero: 'Drama',
            local: 'Teatro Santa Isabel',
            quando: '2024-10-16',
            hora: '19:00:00',
            poster: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS5LP_4Fc1TXjepIRxOZuSCHMFhY6yKJhRSsg&s',
            posterdetalhes: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS5LP_4Fc1TXjepIRxOZuSCHMFhY6yKJhRSsg&s',
            sinopse: 'Fragmentos de cartas nunca enviadas se transformam em cena, explorando sil√™ncio, identidade e a for√ßa das pequenas escolhas que mudam destinos.',
            disponibilizados: 95,
            disponiveis: 27
          },
          {
            id: 'cidade-som',
            nome: 'Cidade-Som',
            classificacao: 'Livre',
            genero: 'Instala√ß√£o c√™nica',
            local: 'Parque Dona Lindu',
            quando: '2024-10-17',
            hora: '17:00:00',
            poster: 'https://www.ceara.gov.br/wp-content/uploads/2024/06/2024-04-12_Orquestra_Juruviara_ThiagoMatine-22-scaled.jpeg',
            posterdetalhes: 'https://www.ceara.gov.br/wp-content/uploads/2024/06/2024-04-12_Orquestra_Juruviara_ThiagoMatine-22-scaled.jpeg',
            sinopse: 'Instala√ß√£o c√™nica com m√∫sica ao vivo em que o p√∫blico percorre paisagens sonoras e descobre personagens escondidos no ru√≠do da cidade.',
            disponibilizados: 200,
            disponiveis: 140
          },
          {
            id: 'o-ultimo-fio',
            nome: 'O √öltimo Fio',
            classificacao: '18+',
            genero: 'Trag√©dia',
            local: 'Teatro Apolo',
            quando: '2024-10-18',
            hora: '21:00:00',
            poster: 'https://www.garanhunsnoticias.com.br/images/noticias/124568/7c2c527a1ffdc43b66f3be20629667e9.jpeg',
            posterdetalhes: 'https://www.garanhunsnoticias.com.br/images/noticias/124568/7c2c527a1ffdc43b66f3be20629667e9.jpeg',
            sinopse: 'Dois irm√£os costuram lembran√ßas para n√£o esquecer o que o tempo tenta rasgar. Um drama √≠ntimo sobre fam√≠lia, perda e possibilidades de recome√ßo.',
            disponibilizados: 85,
            disponiveis: 19
          },
          {
            id: 'coura√ßa',
            nome: 'Coura√ßa',
            classificacao: '14+',
            genero: 'Teatro f√≠sico',
            local: 'Teatro Luiz Mendon√ßa',
            quando: '2024-10-19',
            hora: '20:00:00',
            poster: 'https://www.estadao.com.br/blogs/blog/wp-content/uploads/sites/265/2015/10/Jaques-e-Seu-Amo-HugoPossolo-Ando-Camargo-Angelo-Brandini-foto-de-Jo%C3%A3o-Caldas-e1444340873610.jpg',
            posterdetalhes: 'https://www.estadao.com.br/blogs/blog/wp-content/uploads/sites/265/2015/10/Jaques-e-Seu-Amo-HugoPossolo-Ando-Camargo-Angelo-Brandini-foto-de-Jo%C3%A3o-Caldas-e1444340873610.jpg',
            sinopse: 'Corpos que dan√ßam e falas entrecortadas constroem um mosaico sobre prote√ß√£o e vulnerabilidade em tempos de urg√™ncia.',
            disponibilizados: 130,
            disponiveis: 72
          },
          {
            id: 'menina-e-o-vento',
            nome: 'A Menina e o Vento',
            classificacao: '10+',
            genero: 'Infantil',
            local: 'Pa√ßo do Frevo',
            quando: '2024-10-20',
            hora: '16:00:00',
            poster: 'https://www.sociedadehumboldt.org.br/conteudo/comunicacao/dicas/teatro/1206294/1.jpg',
            posterdetalhes: 'https://www.sociedadehumboldt.org.br/conteudo/comunicacao/dicas/teatro/1206294/1.jpg',
            sinopse: 'A amizade improv√°vel entre uma crian√ßa curiosa e um vento brincalh√£o desafia regras e apresenta uma nova forma de habitar o mundo.',
            disponibilizados: 160,
            disponiveis: 88
          },
          {
            id: 'rio-subterraneo',
            nome: 'Rio Subterr√¢neo',
            classificacao: '12+',
            genero: 'Suspense',
            local: 'Parque Dona Lindu',
            quando: '2024-10-21',
            hora: '18:00:00',
            poster: 'https://s2-oglobo.glbimg.com/Vg94jDR50UtDXMDM39fXOg8nRU0=/0x0:4928x3280/924x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_da025474c0c44edd99332dddb09cabe8/internal_photos/bs/2023/j/q/UyrFCpTqKuAdvuqyYJYQ/perversa-monica-bittencourt-em-cena-5-credito-da-foto-bruna-diacoyannis-1-.jpeg',
            posterdetalhes: 'https://s2-oglobo.glbimg.com/Vg94jDR50UtDXMDM39fXOg8nRU0=/0x0:4928x3280/924x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_da025474c0c44edd99332dddb09cabe8/internal_photos/bs/2023/j/q/UyrFCpTqKuAdvuqyYJYQ/perversa-monica-bittencourt-em-cena-5-credito-da-foto-bruna-diacoyannis-1-.jpeg',
            sinopse: 'Narrativa que revela um Recife oculto sob as √°guas, onde mem√≥rias afundadas retornam para guiar um grupo em busca de pertencimento.',
            disponibilizados: 145,
            disponiveis: 54
          }
        ];
        const DATE_KEY_EMPTY = '__sem_data__';
        const selecoesPorData = new Map();
        const eventosPorId = new Map();
        let eventos = [];
        let eventosFiltrados = [];

        let elGrid;
        let elResultInfo;
        let elQ;
        let elFLocal;
        let elFClass;
        let elFGenero;
        let elBtnLimpar;

        let modal;
        let mTitle;
        let mPoster;
        let mClass;
        let mLocal;
        let mQuando;
        let mGenero;
        let mSinopse;
        let mTicketBtn;

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }

        async function init() {
          elGrid = document.querySelector('#grid');
          elResultInfo = document.querySelector('#resultInfo');
          elQ = document.querySelector('#q');
          elFLocal = document.querySelector('#fTeatro');
          elFClass = document.querySelector('#fClass');
          elFGenero = document.querySelector('#fGenero');
          elBtnLimpar = document.querySelector('#btnLimpar');

          modal = new bootstrap.Modal(document.querySelector('#modalDetalhes'));
          mTitle = document.querySelector('#modalTitulo');
          mPoster = document.querySelector('#modalPoster');
          mClass = document.querySelector('#modalClass');
          mLocal = document.querySelector('#modalTeatro');
          mQuando = document.querySelector('#modalQuando');
          mGenero = document.querySelector('#modalGenero');
          mSinopse = document.querySelector('#modalSinopse');
          mTicketBtn = document.querySelector('#modalTicketBtn');

          document.body.classList.add('portal-dyn');
          injetarEstilos();

          const recebidos = await fetchEventos();
          const base = recebidos.length ? recebidos : FALLBACK_EVENTOS;
          eventos = prepararEventos(base);
          eventosFiltrados = [...eventos];
          popularFiltros(eventos);
          renderCards(eventosFiltrados);
          atualizarResultado();
          registrarEventos();
        }

        function injetarEstilos() {
          const estilo = document.createElement('style');
          estilo.textContent = `.portal-dyn .inativo { filter: grayscale(100%); opacity: .6; pointer-events: none; }
.portal-dyn .selecionado { outline: 2px solid currentColor; }`;
          document.body.appendChild(estilo);
        }

        async function fetchEventos() {
          try {
            const resposta = await fetch(API_URL, { headers: { Accept: 'application/json' } });
            if (!resposta.ok) {
              throw new Error(`Erro HTTP ${resposta.status}`);
            }
            const dados = await resposta.json();
            return Array.isArray(dados) ? dados : [];
          } catch (erro) {
            console.error('Falha ao buscar eventos', erro);
            return [];
          }
        }

        function prepararEventos(lista) {
          eventosPorId.clear();
          selecoesPorData.clear();
          return lista
            .filter((item) => item && item.id)
            .map((item) => {
              const { texto, normalizado, horaCurta } = formatarDataHora(item.quando, item.hora);
              const preparado = {
                id: String(item.id),
                nome: item.nome || 'Evento',
                classificacao: item.classificacao || 'Livre',
                genero: item.genero || '',
                local: item.local || item.teatro || '',
                quandoOriginal: item.quando || '',
                horaOriginal: item.hora || '',
                quandoFormatado: texto,
                quandoNormalizado: normalizado || DATE_KEY_EMPTY,
                horaCurta: horaCurta,
                poster: item.poster || '',
                posterdetalhes: item.posterdetalhes || item.poster || '',
                sinopse: item.sinopse || '',
                disponibilizados: numeroSeguro(item.disponibilizados),
                disponiveis: numeroSeguro(item.disponiveis)
              };
              eventosPorId.set(preparado.id, preparado);
              return preparado;
            });
        }

        function numeroSeguro(valor) {
          const numero = Number(valor);
          return Number.isFinite(numero) && numero >= 0 ? numero : 0;
        }

        function registrarEventos() {
          if (elGrid) {
            elGrid.addEventListener('click', aoClicarNoGrid);
          }
          if (elQ) {
            elQ.addEventListener('input', aplicarFiltros);
          }
          [elFLocal, elFClass, elFGenero].forEach((select) => {
            if (select) {
              select.addEventListener('change', aplicarFiltros);
            }
          });
          if (elBtnLimpar) {
            elBtnLimpar.addEventListener('click', (evento) => {
              evento.preventDefault();
              limparFiltros();
            });
          }
          if (mTicketBtn) {
            mTicketBtn.addEventListener('click', () => {
              const id = mTicketBtn.dataset.id;
              if (!id) return;
              const evento = eventosPorId.get(id);
              if (!evento) return;
              const chave = evento.quandoNormalizado || DATE_KEY_EMPTY;
              togglePorData(chave, id);
            });
          }
        }

        function popularFiltros(lista) {
          preencherSelect(elFLocal, lista.map((e) => e.local).filter(Boolean));
          preencherSelect(elFClass, lista.map((e) => e.classificacao).filter(Boolean));
          preencherSelect(elFGenero, lista.map((e) => e.genero).filter(Boolean));
        }

        function preencherSelect(select, valores) {
          if (!select) return;
          while (select.options.length > 1) {
            select.remove(1);
          }
          const unicos = Array.from(new Set(valores));
          const collator = new Intl.Collator('pt-BR');
          unicos.sort(collator.compare);
          unicos.forEach((valor) => {
            const opcao = document.createElement('option');
            opcao.value = valor;
            opcao.textContent = valor;
            select.appendChild(opcao);
          });
        }

        function aplicarFiltros() {
          const termo = (elQ ? elQ.value : '').trim().toLowerCase();
          const filtroLocal = elFLocal ? elFLocal.value : '';
          const filtroClass = elFClass ? elFClass.value : '';
          const filtroGenero = elFGenero ? elFGenero.value : '';

          eventosFiltrados = eventos.filter((evento) => {
            const textoOk = !termo ||
              [evento.nome, evento.local, evento.sinopse, evento.genero]
                .filter(Boolean)
                .some((campo) => campo.toLowerCase().includes(termo));
            const localOk = !filtroLocal || evento.local === filtroLocal;
            const classOk = !filtroClass || evento.classificacao === filtroClass;
            const generoOk = !filtroGenero || evento.genero === filtroGenero;
            return textoOk && localOk && classOk && generoOk;
          });
          renderCards(eventosFiltrados);
          atualizarResultado();
        }

        function limparFiltros() {
          if (elQ) elQ.value = '';
          [elFLocal, elFClass, elFGenero].forEach((select) => {
            if (select) select.value = '';
          });
          eventosFiltrados = [...eventos];
          renderCards(eventosFiltrados);
          atualizarResultado();
        }

        function renderCards(lista) {
          if (!elGrid) return;
          while (elGrid.firstChild) {
            elGrid.removeChild(elGrid.firstChild);
          }
          const fragmento = document.createDocumentFragment();
          lista.forEach((evento) => {
            fragmento.appendChild(criarCard(evento));
          });
          elGrid.appendChild(fragmento);
          atualizarEstadoTodos();
        }

        function criarCard(evento) {
          const coluna = document.createElement('div');
          coluna.className = 'col';

          const card = document.createElement('article');
          card.className = 'ticket-card h-100 d-flex flex-column';
          card.setAttribute('data-id', evento.id);
          card.setAttribute('data-quando', evento.quandoNormalizado || DATE_KEY_EMPTY);
          card.setAttribute('data-hora', evento.horaCurta || '');

          const capa = document.createElement('div');
          capa.className = 'ticket-cover ratio ratio-16x9';
          const imagem = document.createElement('img');
          imagem.className = 'poster-img';
          imagem.loading = 'lazy';
          imagem.src = evento.poster || '';
          imagem.alt = `P√¥ster da pe√ßa ${evento.nome}`;
          capa.appendChild(imagem);
          card.appendChild(capa);

          const corpo = document.createElement('div');
          corpo.className = 'ticket-body d-flex flex-column gap-2';

          const cabecalho = document.createElement('div');
          cabecalho.className = 'd-flex align-items-center justify-content-between';
          const titulo = document.createElement('h5');
          titulo.className = 'mb-0 fw-bold text-truncate';
          titulo.title = evento.nome;
          titulo.textContent = evento.nome;
          cabecalho.appendChild(titulo);
          cabecalho.appendChild(criarClassificacao(evento.classificacao));
          corpo.appendChild(cabecalho);

          const blocoInfo = document.createElement('div');
          blocoInfo.className = 'row g-2 mt-2';
          blocoInfo.appendChild(criarMeta('G√™nero e local', montarGeneroLocal(evento)));
          blocoInfo.appendChild(criarMeta('Data e hora', evento.quandoFormatado || '‚Äî'));
          blocoInfo.appendChild(criarMeta('Ingressos', `Dispon√≠veis: ${evento.disponiveis} / ${evento.disponibilizados}`));
          corpo.appendChild(blocoInfo);

          const acoes = document.createElement('div');
          acoes.className = 'd-grid gap-2 mt-3';
          const botaoIngresso = document.createElement('button');
          botaoIngresso.type = 'button';
          botaoIngresso.className = 'btn btn-primary btn-sm btn-pegar-ingresso';
          botaoIngresso.textContent = 'Pegar ingresso üéüÔ∏è';
          botaoIngresso.setAttribute('aria-pressed', 'false');
          botaoIngresso.setAttribute('aria-disabled', 'false');
          botaoIngresso.dataset.id = evento.id;
          acoes.appendChild(botaoIngresso);

          const botaoDetalhes = document.createElement('button');
          botaoDetalhes.type = 'button';
          botaoDetalhes.className = 'btn btn-outline-secondary btn-sm';
          botaoDetalhes.setAttribute('data-detalhes', evento.id);
          botaoDetalhes.textContent = 'Detalhes';
          acoes.appendChild(botaoDetalhes);

          corpo.appendChild(acoes);
          card.appendChild(corpo);
          coluna.appendChild(card);
          return coluna;
        }

        function criarMeta(rotulo, valor) {
          const grupo = document.createElement('div');
          grupo.className = 'col-12';
          const label = document.createElement('div');
          label.className = 'meta-label';
          label.textContent = rotulo;
          const texto = document.createElement('div');
          texto.className = 'fw-semibold small';
          texto.textContent = valor;
          if (rotulo === 'G√™nero e local') {
            texto.classList.add('text-truncate');
            texto.title = valor;
          }
          grupo.appendChild(label);
          grupo.appendChild(texto);
          return grupo;
        }

        function criarClassificacao(classificacao) {
          const info = obterClassificacao(classificacao);
          const span = document.createElement('span');
          span.className = `ci ${info.classe}`;
          span.title = `Classifica√ß√£o: ${info.rotuloCompleto}`;
          span.setAttribute('aria-label', `Classifica√ß√£o ${info.rotuloCompleto}`);
          span.textContent = info.rotulo;
          return span;
        }

        function obterClassificacao(valor) {
          const mapa = {
            Livre: { classe: 'l', rotulo: 'L', rotuloCompleto: 'Livre' },
            '10+': { classe: 'c10', rotulo: '10', rotuloCompleto: '10+' },
            '12+': { classe: 'c12', rotulo: '12', rotuloCompleto: '12+' },
            '14+': { classe: 'c14', rotulo: '14', rotuloCompleto: '14+' },
            '16+': { classe: 'c16', rotulo: '16', rotuloCompleto: '16+' },
            '18+': { classe: 'c18', rotulo: '18', rotuloCompleto: '18+' }
          };
          return mapa[valor] || mapa['Livre'];
        }

        function montarGeneroLocal(evento) {
          if (evento.genero && evento.local) {
            return `${evento.genero} ‚Ä¢ ${evento.local}`;
          }
          return evento.genero || evento.local || '‚Äî';
        }

        function aoClicarNoGrid(evento) {
          const botaoIngresso = evento.target.closest('.btn-pegar-ingresso');
          if (botaoIngresso) {
            const card = botaoIngresso.closest('[data-id]');
            if (!card) return;
            const chave = card.getAttribute('data-quando') || DATE_KEY_EMPTY;
            const id = card.getAttribute('data-id');
            togglePorData(chave, id);
            return;
          }
          const botaoDetalhes = evento.target.closest('[data-detalhes]');
          if (botaoDetalhes) {
            const card = botaoDetalhes.closest('[data-id]');
            if (!card) return;
            const id = card.getAttribute('data-id');
            const dados = eventosPorId.get(id);
            if (dados) {
              abrirModal(dados);
            }
          }
        }

        function togglePorData(quandoNormalizado, id) {
          const chave = quandoNormalizado || DATE_KEY_EMPTY;
          const atual = selecoesPorData.get(chave);
          if (atual === id) {
            selecoesPorData.delete(chave);
          } else {
            selecoesPorData.set(chave, id);
          }
          atualizarEstadoDosCards(chave);
          atualizarBotaoModal();
        }

        function atualizarEstadoDosCards(chave) {
          if (!elGrid) return;
          const selecionado = selecoesPorData.get(chave) || null;
          const cards = elGrid.querySelectorAll(`[data-quando="${chave}"]`);
          cards.forEach((card) => {
            const botao = card.querySelector('.btn-pegar-ingresso');
            const idCard = card.getAttribute('data-id');
            const ativo = selecionado && selecionado === idCard;
            if (ativo) {
              card.classList.add('selecionado');
              card.classList.remove('inativo');
              if (botao) {
                botao.disabled = false;
                botao.setAttribute('aria-disabled', 'false');
                botao.setAttribute('aria-pressed', 'true');
                botao.classList.add('btn-success');
                botao.classList.remove('btn-primary');
                botao.textContent = 'Ingresso selecionado üéüÔ∏è';
              }
            } else if (selecionado) {
              card.classList.add('inativo');
              card.classList.remove('selecionado');
              if (botao) {
                botao.disabled = true;
                botao.setAttribute('aria-disabled', 'true');
                botao.setAttribute('aria-pressed', 'false');
                botao.classList.remove('btn-success');
                if (!botao.classList.contains('btn-primary')) {
                  botao.classList.add('btn-primary');
                }
                botao.textContent = 'Pegar ingresso üéüÔ∏è';
              }
            } else {
              card.classList.remove('inativo', 'selecionado');
              if (botao) {
                botao.disabled = false;
                botao.setAttribute('aria-disabled', 'false');
                botao.setAttribute('aria-pressed', 'false');
                botao.classList.remove('btn-success');
                if (!botao.classList.contains('btn-primary')) {
                  botao.classList.add('btn-primary');
                }
                botao.textContent = 'Pegar ingresso üéüÔ∏è';
              }
            }
          });
        }

        function atualizarEstadoTodos() {
          const chaves = new Set();
          selecoesPorData.forEach((_, chave) => chaves.add(chave));
          if (chaves.size === 0) {
            atualizarEstadoDosCards(DATE_KEY_EMPTY);
          }
          chaves.forEach((chave) => atualizarEstadoDosCards(chave));
        }

        function abrirModal(evento) {
          if (!mTitle) return;
          mTitle.textContent = evento.nome;
          if (mPoster) {
            mPoster.src = evento.posterdetalhes || evento.poster || '';
            mPoster.alt = `P√¥ster da pe√ßa ${evento.nome}`;
          }
          if (mClass) {
            const info = obterClassificacao(evento.classificacao);
            mClass.className = `ci ${info.classe}`;
            mClass.textContent = info.rotulo;
          }
          if (mLocal) mLocal.textContent = evento.local || '‚Äî';
          if (mQuando) mQuando.textContent = evento.quandoFormatado || '‚Äî';
          if (mGenero) mGenero.textContent = evento.genero || '‚Äî';
          if (mSinopse) mSinopse.textContent = evento.sinopse || '‚Äî';
          if (mTicketBtn) {
            mTicketBtn.dataset.id = evento.id;
            mTicketBtn.dataset.quando = evento.quandoNormalizado || DATE_KEY_EMPTY;
            mTicketBtn.dataset.hora = evento.horaCurta || '';
          }
          atualizarBotaoModal();
          modal.show();
        }

        function atualizarBotaoModal() {
          if (!mTicketBtn) return;
          const id = mTicketBtn.dataset.id;
          if (!id) return;
          const evento = eventosPorId.get(id);
          if (!evento) return;
          const chave = evento.quandoNormalizado || DATE_KEY_EMPTY;
          const selecionado = selecoesPorData.get(chave);
          const ativo = selecionado === id;
          const bloqueado = selecionado && selecionado !== id;

          if (bloqueado) {
            mTicketBtn.disabled = true;
            mTicketBtn.setAttribute('aria-disabled', 'true');
            mTicketBtn.setAttribute('aria-pressed', 'false');
            mTicketBtn.textContent = 'üéüÔ∏è Indispon√≠vel';
            mTicketBtn.classList.remove('btn-success');
            if (!mTicketBtn.classList.contains('btn-outline-secondary')) {
              mTicketBtn.classList.add('btn-outline-secondary');
            }
            mTicketBtn.classList.remove('btn-outline-primary');
          } else if (ativo) {
            mTicketBtn.disabled = false;
            mTicketBtn.setAttribute('aria-disabled', 'false');
            mTicketBtn.setAttribute('aria-pressed', 'true');
            mTicketBtn.textContent = 'üéüÔ∏è Ingresso selecionado';
            mTicketBtn.classList.add('btn-success');
            mTicketBtn.classList.remove('btn-outline-secondary');
            mTicketBtn.classList.remove('btn-outline-primary');
          } else {
            mTicketBtn.disabled = false;
            mTicketBtn.setAttribute('aria-disabled', 'false');
            mTicketBtn.setAttribute('aria-pressed', 'false');
            mTicketBtn.textContent = 'üéüÔ∏è Pegar ingresso';
            mTicketBtn.classList.remove('btn-success');
            mTicketBtn.classList.remove('btn-outline-secondary');
            if (!mTicketBtn.classList.contains('btn-outline-primary')) {
              mTicketBtn.classList.add('btn-outline-primary');
            }
          }
        }

        function atualizarResultado() {
          if (!elResultInfo) return;
          elResultInfo.textContent = `Exibindo ${eventosFiltrados.length} de ${eventos.length}`;
        }

        function formatarDataHora(quando, hora) {
          if (!quando) {
            return { texto: '', normalizado: '', horaCurta: '' };
          }
          const horaNormalizada = normalizarHora(hora);
          const dataISO = `${quando}T${horaNormalizada}`;
          const data = new Date(dataISO);
          if (Number.isNaN(data.getTime())) {
            return { texto: '', normalizado: '', horaCurta: '' };
          }
          const partes = new Intl.DateTimeFormat('pt-BR', {
            timeZone: 'America/Recife',
            day: '2-digit',
            month: 'long',
            hour: '2-digit',
            minute: '2-digit'
          }).formatToParts(data);
          const dia = partes.find((p) => p.type === 'day')?.value || '';
          const mes = (partes.find((p) => p.type === 'month')?.value || '').toLowerCase();
          const horaParte = partes.find((p) => p.type === 'hour')?.value || '00';
          const minutoParte = partes.find((p) => p.type === 'minute')?.value || '00';
          const sufixoHora = minutoParte !== '00' ? `${horaParte}h${minutoParte}` : `${horaParte}h`;
          const texto = dia && mes ? `${dia} ${mes}, ${sufixoHora}` : '';
          const normalizadoPartes = new Intl.DateTimeFormat('en-CA', {
            timeZone: 'America/Recife',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
          }).formatToParts(data);
          const ano = normalizadoPartes.find((p) => p.type === 'year')?.value || '';
          const mesNum = normalizadoPartes.find((p) => p.type === 'month')?.value || '';
          const diaNum = normalizadoPartes.find((p) => p.type === 'day')?.value || '';
          return {
            texto,
            normalizado: ano && mesNum && diaNum ? `${ano}-${mesNum}-${diaNum}` : '',
            horaCurta: `${horaParte}:${minutoParte}`
          };
        }

        function normalizarHora(hora) {
          if (!hora) return '00:00:00';
          if (/^\d{2}:\d{2}:\d{2}$/.test(hora)) return hora;
          if (/^\d{2}:\d{2}$/.test(hora)) return `${hora}:00`;
          return '00:00:00';
        }
      })();
    </script>

  </body>
</html>
